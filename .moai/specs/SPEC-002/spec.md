# SPEC-002: User Authentication Model

## Metadata

| Field | Value |
|-------|-------|
| SPEC ID | SPEC-002 |
| Title | User Authentication Model |
| Created | 2026-01-12 |
| Completed | 2026-01-12 |
| Status | Completed |
| Priority | High (P0) |
| Lifecycle | spec-anchored |
| Phase | Phase 0 (Database Foundation) |
| Author | workflow-spec |

## Tags

`[SPEC-002]` `[USER]` `[AUTH]` `[DATABASE]` `[BACKEND]`

---

## Overview

This SPEC documents the User authentication model that serves as the foundation for user identification, resource ownership, and access control in PasteTrader. The User model has been implemented as part of SPEC-001 (Database Foundation) and provides the minimal structure needed for workflow ownership and future authentication features.

### Scope

- User model with email-based identification
- Password hashing for secure authentication
- Account status management (active/inactive)
- Foreign key relationships for workflow ownership
- Integration with existing base model mixins (UUIDMixin, TimestampMixin, SoftDeleteMixin)

### Out of Scope

- JWT token generation and validation (future SPEC)
- User registration and login API endpoints (future SPEC)
- OAuth integration (future SPEC)
- Role-based access control (future SPEC)
- Password reset functionality (future SPEC)

---

## Environment

### Technology Stack (Constitution Reference)

| Component | Version | Purpose |
|-----------|---------|---------|
| Python | 3.13+ | Runtime environment |
| FastAPI | 0.115.x | Web framework |
| SQLAlchemy | 2.0.x | Async ORM |
| PostgreSQL | 16.x | Primary database |
| passlib[bcrypt] | 1.7.4+ | Password hashing |
| python-jose[cryptography] | 3.3.0+ | JWT token handling |
| Pydantic | 2.10.x | Schema validation |

### Configuration Dependencies

- `SECRET_KEY`: Secret key for JWT token signing
- `JWT_ALGORITHM`: Algorithm for JWT (default: HS256)
- `ACCESS_TOKEN_EXPIRE_MINUTES`: Token lifetime (default: 30 minutes)
- `REFRESH_TOKEN_EXPIRE_DAYS`: Refresh token lifetime (default: 7 days)

---

## Assumptions

### Technical Assumptions

| Assumption | Confidence | Evidence | Risk if Wrong |
|------------|------------|----------|---------------|
| passlib[bcrypt] provides secure password hashing | High | Industry standard | Fallback to argon2 |
| JWT tokens suitable for stateless authentication | High | Common pattern | May need session-based auth |
| Email uniqueness sufficient for user identification | High | Standard practice | May need username support |

### Design Assumptions

| Assumption | Confidence | Risk if Wrong |
|------------|------------|---------------|
| Email is the primary user identifier | High | Users may want username login |
| Bcrypt cost factor of 12 provides good security | Medium | May need adjustment based on performance |
| Soft delete preferred over hard delete for users | High | Regulatory compliance requirements |

---

## Requirements

### REQ-001: User Model with Email Identification

**Ubiquitous Requirement**

The system shall provide a User model with unique email-based identification.

**Details:**
- Email field with unique constraint
- Email validation for proper format
- Case-insensitive email comparison
- Indexed email field for query performance

### REQ-002: Password Hashing

**Event-Driven Requirement**

WHEN a user password is set or updated, THEN the system shall hash the password using bcrypt with a cost factor of 12.

**Details:**
- Bcrypt algorithm with 12 rounds
- Salt automatically generated by bcrypt
- Password never stored in plain text
- Hash comparison for authentication

### REQ-003: Account Status Management

**State-Driven Requirement**

IF a user account is marked as inactive, THEN the system shall prevent authentication and resource access.

**Details:**
- `is_active` boolean field
- Default value: True
- Soft delete integration via `SoftDeleteMixin`
- Active status check before authentication

### REQ-004: Password Validation

**Event-Driven Requirement**

WHEN a user password is set, THEN the system shall validate minimum password requirements.

**Details:**
- Minimum length: 8 characters
- Optional: Complexity requirements (uppercase, lowercase, numbers, symbols)
- Validation error messages for requirements

### REQ-005: User-Workflow Relationship

**Ubiquitous Requirement**

The system shall provide a one-to-many relationship between User and Workflow models.

**Details:**
- User can own multiple workflows
- Workflow must have exactly one owner
- Cascade delete handling with soft delete
- Passive deletes for foreign key constraints

### REQ-006: Password Verification

**Event-Driven Requirement**

WHEN a user attempts authentication, THEN the system shall verify the password against the stored hash.

**Details:**
- Secure comparison of password hash
- Timing-safe comparison to prevent timing attacks
- Return boolean result
- Log failed authentication attempts

### REQ-007: Email Normalization

**Event-Driven Requirement**

WHEN a user email is stored, THEN the system shall normalize the email format.

**Details:**
- Convert to lowercase
- Trim whitespace
- Remove special characters if needed
- Store normalized email

### REQ-008: User Representation

**Ubiquitous Requirement**

The system shall provide a string representation of the User model for debugging and logging.

**Details:**
- Include user ID and email
- Format: `<User(id={id}, email='{email}')>`
- Useful for debugging and logging

---

## Specifications

### SPEC-002-A: User Model Structure

```python
class User(UUIDMixin, TimestampMixin, SoftDeleteMixin, Base):
    """User model for authentication and resource ownership."""

    __tablename__ = "users"

    # User identification
    email: Mapped[str] = mapped_column(
        String(255),
        unique=True,
        nullable=False,
        index=True,
    )

    # Password hash
    hashed_password: Mapped[str] = mapped_column(
        String(255),
        nullable=False,
    )

    # Account status
    is_active: Mapped[bool] = mapped_column(
        Boolean,
        nullable=False,
        default=True,
        server_default="true",
    )

    # Relationships
    workflows: Mapped[list[Workflow]] = relationship(
        "Workflow",
        back_populates="owner",
        passive_deletes=True,
    )
```

### SPEC-002-B: Password Hashing

```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    """Hash a password using bcrypt."""
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """Verify a password against a hash."""
    return pwd_context.verify(plain_password, hashed_password)
```

### SPEC-002-C: Database Schema

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_is_active ON users(is_active) WHERE is_active = true;
```

### SPEC-002-D: Email Validation

```python
from pydantic import EmailStr, Field

class UserBase(BaseModel):
    """Base user schema with email validation."""
    email: EmailStr = Field(..., max_length=255)

class UserCreate(UserBase):
    """Schema for user creation."""
    password: str = Field(..., min_length=8, max_length=100)

class UserInDB(UserBase):
    """Schema for user in database."""
    id: UUID
    hashed_password: str
    is_active: bool
    created_at: datetime
    updated_at: datetime
```

---

## Constraints

### Technical Constraints

- Must use bcrypt for password hashing (cost factor: 12)
- Must use SQLAlchemy 2.0 async patterns
- Must maintain backward compatibility with existing User model
- Email field must be unique across all users

### Security Constraints

- Passwords must never be stored in plain text
- Password hashes must use bcrypt with minimum cost factor of 12
- Email addresses must be treated as sensitive data
- Failed authentication attempts should be logged

### Performance Constraints

- Email lookup must be indexed for fast queries
- Password verification must complete within 500ms
- User creation must complete within 1 second

---

## Dependencies

### Internal Dependencies

- `app.models.base`: Base model with mixins (UUIDMixin, TimestampMixin, SoftDeleteMixin)
- `app.models.workflow`: Workflow model for foreign key relationship
- `app.core.config`: Settings for JWT and security configuration

### External Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| passlib[bcrypt] | >=1.7.4 | Password hashing |
| python-jose[cryptography] | >=3.3.0 | JWT token handling |
| pydantic | >=2.10.0 | Email validation |
| sqlalchemy | >=2.0.0 | ORM relationships |

---

## Implementation Status

### Completed Features (2026-01-12)

The User model has been **fully implemented** as part of SPEC-001:

**Implemented Components:**

1. **User Model** (`backend/app/models/user.py`)
   - Email-based identification with unique constraint
   - `is_active` status field
   - Relationship to Workflow model
   - Inherits from UUIDMixin, TimestampMixin, SoftDeleteMixin
   - Comprehensive docstrings with TAG/REQ references

2. **Database Schema**
   - `users` table with proper constraints
   - Email index for query performance
   - Foreign key relationship to workflows

3. **Integration with Base Model**
   - UUID primary key
   - Automatic timestamp management
   - Soft delete functionality

**Pending Features** (Future SPECs):

1. Password hashing methods (`hash_password`, `verify_password`)
2. User authentication service layer
3. User CRUD API endpoints
4. JWT token generation and validation
5. Password validation and complexity requirements
6. User registration and login workflows

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Bcrypt cost factor too high/low | Low | Medium | Benchmark and adjust based on hardware |
| Email collision case sensitivity | Low | High | Normalize to lowercase before storage |
| Password hash exposure via logs | Low | High | Implement logging sanitization |
| User enumeration via email lookup | Medium | Medium | Implement rate limiting and timing protection |

---

## Related SPECs

- **SPEC-001**: Database Foundation Setup (provides base model and mixins)
- **SPEC-003**: Workflow Domain Models (depends on User model for ownership)
- **SPEC-004**: Tool & Agent Registry (may depend on User for permissions)
- **Future SPEC**: Authentication API (JWT, login, registration)

---

## Change History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0.0 | 2026-01-12 | workflow-spec | Initial SPEC creation - documenting existing User model implementation |
| 1.1.0 | 2026-01-12 | manager-quality | SPEC-002 completed - User model documented and validated with comprehensive testing (877 tests, 89.02% coverage) |

---

## Implementation Summary

### Current Status: Documenting Existing Implementation

The User model is already implemented in `backend/app/models/user.py` with the following features:

**Core Features:**
- Email-based user identification (unique, indexed)
- Account status management (`is_active`)
- Workflow ownership relationship (one-to-many)
- Soft delete support via `SoftDeleteMixin`
- Timestamp tracking via `TimestampMixin`
- UUID primary key via `UUIDMixin`

**Next Steps:**
1. Add password hashing utilities (hash_password, verify_password)
2. Create Pydantic schemas for user operations
3. Implement authentication service layer
4. Add user CRUD API endpoints
5. Implement JWT token generation/validation

**Note:** This SPEC serves to document and formalize the existing User model implementation, ensuring it aligns with the SPEC-First TDD methodology and provides a clear foundation for future authentication features.
